function CitiesManager(){this.cities=[],this.cities.push(new City([(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2])),this.cities.push(new City([2*(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2])),this.cities.push(new City([3*(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2])),this.cities.push(new City([CANVAS_WIDTH/2-cannonSize/2+(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2])),this.cities.push(new City([CANVAS_WIDTH/2-cannonSize/2+2*(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2])),this.cities.push(new City([CANVAS_WIDTH/2-cannonSize/2+3*(CANVAS_WIDTH/2-cannonSize-cannonSize/2)/3,CANVAS_HEIGHT-basesHeight-citySize/2]))}function City(a){this.toDestroy=!1,this.position=a}function EnemyMissile(a,b){this.initialPosition=a,this.position=[this.initialPosition[0],this.initialPosition[1]],this.direction=[0,0],this.destination=b,this.toDestroy=!1,this.setDirection()}function Explosion(a){this.toDestroy=!1,this.position=[a[0],a[1]],this.radius=0,this.growing=!0,this.color="white"}function ExplosionsManager(){this.explosions=[]}function setUpCanvas(){canvasElement=$("<canvas class='canvas' onclick = 'fireMissile()' width='"+CANVAS_WIDTH+"' height='"+CANVAS_HEIGHT+"'></canvas>"),canvas=canvasElement.get(0).getContext("2d"),canvasElement.appendTo(".container"),canvas.fillStyle="black",canvas.fillRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT)}function draw(){canvas.fillStyle="black",canvas.fillRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT),missilesManager.draw(),enemyMissilesManager.draw(),explosionsManager.draw(),citiesManager.draw(),drawMisc(),gameOver&&(canvas.fillStyle="white",canvas.font="bold 40px Arial",canvas.fillText("Game Over",CANVAS_WIDTH/2-100,CANVAS_HEIGHT/2-50),canvas.font="bold 20px Arial",canvas.fillText("Press space to restart",CANVAS_WIDTH/2-100,CANVAS_HEIGHT/2))}function update(){gameOver||(missilesManager.update(),enemyMissilesManager.update(),explosionsManager.update(),citiesManager.update(),checkGameOver())}function gameLoop(){update(),draw(),setTimeout(gameLoop,1e3/fps)}function fireMissile(a){var b=canvasElement[0].getBoundingClientRect();a=a||window.event;var c=a.pageX-b.left,d=a.pageY-b.top,e=new Missile([c,d]);missilesManager.add(e)}function drawMisc(){drawBases(),drawCannons(),drawScore()}function drawBases(){canvas.beginPath(),canvas.moveTo(0,CANVAS_HEIGHT),canvas.lineTo(CANVAS_WIDTH,CANVAS_HEIGHT),canvas.lineTo(CANVAS_WIDTH,CANVAS_HEIGHT-basesHeight),canvas.lineTo(0,CANVAS_HEIGHT-basesHeight),canvas.closePath(),canvas.fillStyle="yellow",canvas.fill()}function drawCannons(){drawRect(0,CANVAS_HEIGHT-cannonSize,cannonSize,cannonSize,"yellow"),drawRect(CANVAS_WIDTH/2-cannonSize/2,CANVAS_HEIGHT-cannonSize,cannonSize,cannonSize,"yellow"),drawRect(CANVAS_WIDTH-cannonSize,CANVAS_HEIGHT-cannonSize,cannonSize,cannonSize,"yellow")}function drawScore(){canvas.fillStyle="white",canvas.font="bold 20px Arial",canvas.fillText("Score : "+score,10,20)}function checkGameOver(){0==citiesManager.cities.length&&(gameOver=!0)}function restart(){gameOver=!1,missilesManager=new MissilesManager,explosionsManager=new ExplosionsManager,enemyMissilesManager=new MissilesManager,citiesManager=new CitiesManager,score=0,missilesInterval=1e3,enemySpeed=.5}function fireEnemyMissiles(){enemyMissilesManager.addRandom(),upDifficulty(),setTimeout(fireEnemyMissiles,missilesInterval)}function upDifficulty(){missilesInterval>100&&(missilesInterval-=5),10>enemySpeed&&(enemySpeed+=.03)}function Missile(a){this.destination=a,this.toDestroy=!1,this.initialPosition=this.getClosestBasePosition(),this.position=[this.initialPosition[0],this.initialPosition[1]],this.direction=[0,0],this.setDirection()}function MissilesManager(){this.missiles=[]}function Normalize(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return a[0]/=b,a[1]/=b,a}function drawRect(a,b,c,d,e){canvas.beginPath(),canvas.moveTo(a,b),canvas.lineTo(a+c,b),canvas.lineTo(a+c,b+d),canvas.lineTo(a,b+d),canvas.closePath(),canvas.fillStyle=e,canvas.fill()}CitiesManager.prototype.update=function(){for(var a=0;a<this.cities.length;a++)this.cities[a].update();this.cities=this.cities.filter(function(a){return 0==a.toDestroy})},CitiesManager.prototype.draw=function(){for(var a=0;a<this.cities.length;a++)this.cities[a].draw()};var citySize=20;City.prototype.draw=function(){drawRect(this.position[0]-citySize/2,this.position[1]-citySize/2,citySize,citySize,"lightBlue")},City.prototype.update=function(){if(!this.toDestroy)for(var a=0;a<explosionsManager.explosions.length;a++)explosionsManager.explosions[a].contains(this.position)&&(this.toDestroy=!0)};var enemySpeed=.5;EnemyMissile.prototype.setDirection=function(){this.direction[0]=this.destination[0]-this.initialPosition[0],this.direction[1]=this.initialPosition[1]-this.destination[1],this.direction=Normalize(this.direction)},EnemyMissile.prototype.destinationReached=function(){return this.position[0]>this.destination[0]-5&&this.position[0]<this.destination[0]+5&&this.position[1]>this.destination[1]-5&&this.position[1]<this.destination[1]+5},EnemyMissile.prototype.draw=function(){canvas.lineWidth=2,canvas.strokeStyle="red",canvas.beginPath(),canvas.moveTo(this.initialPosition[0],this.initialPosition[1]),canvas.lineTo(this.position[0],this.position[1]),canvas.stroke(),drawRect(this.position[0]-1,this.position[1]-1,2,2,"white")},EnemyMissile.prototype.update=function(){this.position[0]+=this.direction[0]*enemySpeed,this.position[1]-=this.direction[1]*enemySpeed,(this.position[0]<0||this.position[1]>CANVAS_WIDTH||this.position[1]>CANVAS_HEIGHT-basesHeight)&&(this.toDestroy=!0,e=new Explosion(this.position),e.color="red",explosionsManager.add(e));for(var a=0;a<explosionsManager.explosions.length;a++)explosionsManager.explosions[a].contains(this.position)&&(this.toDestroy=!0,e=new Explosion(this.position),explosionsManager.add(e),score++)};var radiusGrowth=.6,maxRadius=40;Explosion.prototype.update=function(){this.growing&&this.radius<maxRadius?this.radius+=radiusGrowth:(this.growing=!1,this.radius-=radiusGrowth),this.radius<0&&(this.toDestroy=!0)},Explosion.prototype.draw=function(){canvas.beginPath(),canvas.arc(this.position[0],this.position[1],this.radius,0,2*Math.PI,!1),canvas.fillStyle=this.color,canvas.fill()},Explosion.prototype.contains=function(a){var b=Math.abs(a[0]-this.position[0])*Math.abs(a[0]-this.position[0])+Math.abs(a[1]-this.position[1])*Math.abs(a[1]-this.position[1]);return Math.sqrt(b)<this.radius},ExplosionsManager.prototype.update=function(){for(var a=0;a<this.explosions.length;a++)this.explosions[a].update();this.explosions=this.explosions.filter(function(a){return 0==a.toDestroy})},ExplosionsManager.prototype.draw=function(){for(var a=0;a<this.explosions.length;a++)this.explosions[a].draw()},ExplosionsManager.prototype.add=function(a){this.explosions.push(a)};var canvasElement=$("<canvas></canvas>"),canvas,CANVAS_WIDTH=500,CANVAS_HEIGHT=500,fps=60,basesHeight=20,cannonSize=35,gameOver=!1,missilesInterval=1e3,missilesManager=new MissilesManager,explosionsManager=new ExplosionsManager,enemyMissilesManager=new MissilesManager,citiesManager=new CitiesManager,score=0;$(document).ready(function(){setUpCanvas(),setTimeout(gameLoop,1e3/fps),setTimeout(fireEnemyMissiles,0),$(document).keydown(function(a){32==a.which&&gameOver&&restart()})});var speed=8;Missile.prototype.setDirection=function(){this.direction[0]=this.destination[0]-this.initialPosition[0],this.direction[1]=this.initialPosition[1]-this.destination[1],this.direction=Normalize(this.direction)},Missile.prototype.destinationReached=function(){return this.position[0]>this.destination[0]-5&&this.position[0]<this.destination[0]+5&&this.position[1]>this.destination[1]-5&&this.position[1]<this.destination[1]+5},Missile.prototype.draw=function(){canvas.lineWidth=1,canvas.strokeStyle="blue",canvas.beginPath(),canvas.moveTo(this.initialPosition[0],this.initialPosition[1]),canvas.lineTo(this.position[0],this.position[1]),canvas.stroke(),drawRect(this.position[0]-1,this.position[1]-1,2,2,"white")},Missile.prototype.update=function(){this.toDestroy||(this.position[0]+=this.direction[0]*speed,this.position[1]-=this.direction[1]*speed,(this.destinationReached()||this.position[0]<0)&&(this.toDestroy=!0,e=new Explosion(this.position),explosionsManager.add(e)))},Missile.prototype.getClosestBasePosition=function(){return this.destination[0]<CANVAS_WIDTH/3?[cannonSize/2,CANVAS_HEIGHT-cannonSize]:this.destination[0]<2*CANVAS_WIDTH/3?[CANVAS_WIDTH/2,CANVAS_HEIGHT-cannonSize]:[CANVAS_WIDTH-cannonSize/2,CANVAS_HEIGHT-cannonSize]},MissilesManager.prototype.update=function(){for(var a=0;a<this.missiles.length;a++)this.missiles[a].update();this.missiles=this.missiles.filter(function(a){return 0==a.toDestroy})},MissilesManager.prototype.draw=function(){for(var a=0;a<this.missiles.length;a++)this.missiles[a].draw()},MissilesManager.prototype.add=function(a){this.missiles.push(a)},MissilesManager.prototype.addRandom=function(){var a=Math.random()*CANVAS_WIDTH,b=Math.random()*CANVAS_WIDTH,c=new EnemyMissile([a,0],[b,CANVAS_HEIGHT]);this.add(c)};